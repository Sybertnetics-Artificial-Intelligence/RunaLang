Note:
Copyright 2025 Sybertnetics Artificial Intelligence Solutions
Licensed under the Apache License, Version 2.0
:End Note

Note:
RISC-V 32 ATOMIC OPERATIONS
Uses LR.D/SC.D (load-reserved/store-conditional) and AMO instructions
:End Note

Process called "atomic_load_relaxed" takes ptr as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, 0(a0)
        sw a1, -16(fp)
    End Assembly
    Return result
End Process

Process called "atomic_load_acquire" takes ptr as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, 0(a0)
        fence r, rw
        sw a1, -16(fp)
    End Assembly
    Return result
End Process

Process called "atomic_load_seq_cst" takes ptr as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        fence rw, rw
        lw a1, 0(a0)
        fence r, rw
        sw a1, -16(fp)
    End Assembly
    Return result
End Process

Process called "atomic_store_relaxed" takes ptr as Integer, value as Integer returns Integer:
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        sw a1, 0(a0)
    End Assembly
    Return 0
End Process

Process called "atomic_store_release" takes ptr as Integer, value as Integer returns Integer:
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        fence rw, w
        sw a1, 0(a0)
    End Assembly
    Return 0
End Process

Process called "atomic_store_seq_cst" takes ptr as Integer, value as Integer returns Integer:
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        fence rw, w
        sw a1, 0(a0)
        fence rw, rw
    End Assembly
    Return 0
End Process

Process called "atomic_fetch_add" takes ptr as Integer, value as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        amoadd.w.aqrl a2, a1, (a0)
        sw a2, -24(fp)
    End Assembly
    Return result
End Process

Process called "atomic_fetch_sub" takes ptr as Integer, value as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        neg a1, a1
        amoadd.w.aqrl a2, a1, (a0)
        sw a2, -24(fp)
    End Assembly
    Return result
End Process

Process called "atomic_fetch_and" takes ptr as Integer, value as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        amoand.w.aqrl a2, a1, (a0)
        sw a2, -24(fp)
    End Assembly
    Return result
End Process

Process called "atomic_fetch_or" takes ptr as Integer, value as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        amoor.w.aqrl a2, a1, (a0)
        sw a2, -24(fp)
    End Assembly
    Return result
End Process

Process called "atomic_fetch_xor" takes ptr as Integer, value as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        amoxor.w.aqrl a2, a1, (a0)
        sw a2, -24(fp)
    End Assembly
    Return result
End Process

Process called "atomic_compare_and_swap" takes ptr as Integer, expected as Integer, desired as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        lw a2, -24(fp)

        .retry:
        lr.w.aq a3, (a0)
        bne a3, a1, .failed
        sc.w.rl a4, a2, (a0)
        bnez a4, .retry

        li a5, 1
        j .wone

        .failed:
        li a5, 0

        .wone:
        sw a5, -32(fp)
    End Assembly
    Return result
End Process

Process called "atomic_compare_and_swap_weak" takes ptr as Integer, expected as Integer, desired as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        lw a2, -24(fp)

        lr.w.aq a3, (a0)
        bne a3, a1, .failed
        sc.w.rl a4, a2, (a0)
        bnez a4, .failed

        li a5, 1
        j .wone

        .failed:
        li a5, 0

        .wone:
        sw a5, -32(fp)
    End Assembly
    Return result
End Process

Process called "atomic_exchange" takes ptr as Integer, value as Integer returns Integer:
    Let result be 0
    Inline Assembly:
        lw a0, -8(fp)
        lw a1, -16(fp)
        amoswap.w.aqrl a2, a1, (a0)
        sw a2, -24(fp)
    End Assembly
    Return result
End Process

Process called "memory_barrier_acquire" returns Integer:
    Inline Assembly:
        fence r, rw
    End Assembly
    Return 0
End Process

Process called "memory_barrier_release" returns Integer:
    Inline Assembly:
        fence rw, w
    End Assembly
    Return 0
End Process

Process called "memory_barrier_full" returns Integer:
    Inline Assembly:
        fence rw, rw
    End Assembly
    Return 0
End Process

Process called "memory_barrier_seq_cst" returns Integer:
    Inline Assembly:
        fence rw, rw
    End Assembly
    Return 0
End Process
