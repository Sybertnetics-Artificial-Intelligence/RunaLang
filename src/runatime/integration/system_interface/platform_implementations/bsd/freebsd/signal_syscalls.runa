Note:
runa/src/runatime/integration/system_interface/platform_syscalls/bsd/freebsd/signal_syscalls.runa
FreeBSD Signal Management Syscalls

This module provides FreeBSD-specific signal management syscall implementations,
including signal handlers and FreeBSD-specific signal features.

Key features and capabilities:
- Signal handlers (sigaction)
- Signal masks (sigprocmask)
- Signal delivery
- Real-time signals
- Signal queuing
- Signal stacks
- Signal suspension
- Signal information
- Process signaling
- Thread signaling
- Signal timers
- Signal debugging
- Async-signal safety
- Signal chaining
- BSD signal semantics
:End Note

Import "../../../../../../../compiler/backend/syscalls/platforms/freebsd_x64" as FreeBSDPlatform
Import "../../../../../../../compiler/backend/syscalls/platforms/platform_interface" as PlatformInterface
Import "../../../../../../../compiler/frontend/primitives/types/compiler_internals" as Internals

Note: ===== Signal Actions =====

Process called "sys_sigaction" that takes sig as Integer, act as Pointer, oact as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigaction")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal number
        "mov rsi, %2\n"           Note: new action
        "mov rdx, %3\n"           Note: old action
        "mov rax, %4\n"           Note: sigaction syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (sig), "r" (act), "r" (oact), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_signal" that takes sig as Integer, handler as Pointer returns Pointer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("signal")
    Let result be Pointer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal number
        "mov rsi, %2\n"           Note: signal handler
        "mov rax, %3\n"           Note: signal syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (sig), "r" (handler), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Masks =====

Process called "sys_sigprocmask" that takes how as Integer, set as Pointer, oldset as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigprocmask")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: how to change mask
        "mov rsi, %2\n"           Note: new signal set
        "mov rdx, %3\n"           Note: old signal set
        "mov rax, %4\n"           Note: sigprocmask syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (how), "r" (set), "r" (oldset), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigpending" that takes set as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigpending")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: pending signal set
        "mov rax, %2\n"           Note: sigpending syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (set), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigsuspend" that takes sigmask as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigsuspend")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal mask
        "mov rax, %2\n"           Note: sigsuspend syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (sigmask), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Delivery =====

Process called "sys_kill" that takes pid as Integer, sig as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("kill")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: process ID
        "mov rsi, %2\n"           Note: signal number
        "mov rax, %3\n"           Note: kill syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (pid), "r" (sig), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_killpg" that takes pgrp as Integer, sig as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("killpg")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: process group
        "mov rsi, %2\n"           Note: signal number
        "mov rax, %3\n"           Note: killpg syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (pgrp), "r" (sig), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigqueue" that takes pid as Integer, sig as Integer, value as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigqueue")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: process ID
        "mov rsi, %2\n"           Note: signal number
        "mov rdx, %3\n"           Note: signal value
        "mov rax, %4\n"           Note: sigqueue syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (pid), "r" (sig), "r" (value), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Information =====

Process called "sys_sigwait" that takes set as Pointer, sig as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigwait")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal set
        "mov rsi, %2\n"           Note: signal pointer
        "mov rax, %3\n"           Note: sigwait syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (set), "r" (sig), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigwaitinfo" that takes set as Pointer, info as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigwaitinfo")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal set
        "mov rsi, %2\n"           Note: signal info
        "mov rax, %3\n"           Note: sigwaitinfo syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (set), "r" (info), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigtimedwait" that takes set as Pointer, info as Pointer, timeout as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigtimedwait")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal set
        "mov rsi, %2\n"           Note: signal info
        "mov rdx, %3\n"           Note: timeout
        "mov rax, %4\n"           Note: sigtimedwait syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (set), "r" (info), "r" (timeout), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Stacks =====

Process called "sys_sigaltstack" that takes ss as Pointer, oss as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigaltstack")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: new signal stack
        "mov rsi, %2\n"           Note: old signal stack
        "mov rax, %3\n"           Note: sigaltstack syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (ss), "r" (oss), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Return and Context =====

Process called "sys_sigreturn" that takes ucp as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigreturn")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: user context
        "mov rax, %2\n"           Note: sigreturn syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (ucp), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_getcontext" that takes ucp as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("getcontext")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: user context
        "mov rax, %2\n"           Note: getcontext syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (ucp), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_setcontext" that takes ucp as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("setcontext")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: user context
        "mov rax, %2\n"           Note: setcontext syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (ucp), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_swapcontext" that takes oucp as Pointer, ucp as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("swapcontext")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: old user context
        "mov rsi, %2\n"           Note: new user context
        "mov rax, %3\n"           Note: swapcontext syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (oucp), "r" (ucp), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Thread Signaling =====

Process called "sys_pthread_kill" that takes thread as Integer, sig as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("pthread_kill")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: thread ID
        "mov rsi, %2\n"           Note: signal number
        "mov rax, %3\n"           Note: pthread_kill syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (thread), "r" (sig), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_pthread_sigmask" that takes how as Integer, set as Pointer, oldset as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("pthread_sigmask")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: how to change mask
        "mov rsi, %2\n"           Note: new signal set
        "mov rdx, %3\n"           Note: old signal set
        "mov rax, %4\n"           Note: pthread_sigmask syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (how), "r" (set), "r" (oldset), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Real-time Signals =====

Process called "sys_sigqueueinfo" that takes pid as Integer, sig as Integer, info as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigqueueinfo")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: process ID
        "mov rsi, %2\n"           Note: signal number
        "mov rdx, %3\n"           Note: signal info
        "mov rax, %4\n"           Note: sigqueueinfo syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (pid), "r" (sig), "r" (info), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_tgkill" that takes tgid as Integer, tid as Integer, sig as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("tgkill")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: thread group ID
        "mov rsi, %2\n"           Note: thread ID
        "mov rdx, %3\n"           Note: signal number
        "mov rax, %4\n"           Note: tgkill syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (tgid), "r" (tid), "r" (sig), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Safety and Debugging =====

Process called "sys_siginterrupt" that takes sig as Integer, flag as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("siginterrupt")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal number
        "mov rsi, %2\n"           Note: interrupt flag
        "mov rax, %3\n"           Note: siginterrupt syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (sig), "r" (flag), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigblock" that takes mask as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigblock")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal mask
        "mov rax, %2\n"           Note: sigblock syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (mask), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigsetmask" that takes mask as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigsetmask")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal mask
        "mov rax, %2\n"           Note: sigsetmask syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (mask), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process
