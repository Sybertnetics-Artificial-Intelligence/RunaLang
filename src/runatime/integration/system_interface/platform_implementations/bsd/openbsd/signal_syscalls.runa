Note:
runa/src/runatime/integration/system_interface/platform_syscalls/bsd/openbsd/signal_syscalls.runa
OpenBSD Signal Management Syscalls

This module provides OpenBSD-specific signal management syscall implementations,
including signal handlers and OpenBSD-specific signal features.

Key features and capabilities:
- Signal handlers (sigaction)
- Signal masks (sigprocmask)
- Signal delivery
- Real-time signals
- Signal stacks
- Signal suspension
- Signal information
- Process signaling
- Thread signaling
- Signal timers
- Pledge-aware signals
- Secure signal handling
- Async-signal safety
- Signal chaining
- BSD signal semantics
:End Note

Import "../../../../../../../compiler/backend/syscalls/platforms/openbsd_x64" as OpenBSDPlatform
Import "../../../../../../../compiler/backend/syscalls/platforms/platform_interface" as PlatformInterface
Import "../../../../../../../compiler/frontend/primitives/types/compiler_internals" as Internals

Note: ===== Signal Handlers =====

Process called "sys_sigaction" that takes sig as Integer, act as Pointer, oact as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigaction")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal number
        "mov rsi, %2\n"           Note: new action
        "mov rdx, %3\n"           Note: old action
        "mov rax, %4\n"           Note: sigaction syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (sig), "r" (act), "r" (oact), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_signal" that takes sig as Integer, handler as Pointer returns Pointer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("signal")
    Let result be Pointer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal number
        "mov rsi, %2\n"           Note: signal handler
        "mov rax, %3\n"           Note: signal syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (sig), "r" (handler), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Masks =====

Process called "sys_sigprocmask" that takes how as Integer, set as Pointer, oldset as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigprocmask")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: how to change mask
        "mov rsi, %2\n"           Note: new signal set
        "mov rdx, %3\n"           Note: old signal set
        "mov rax, %4\n"           Note: sigprocmask syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (how), "r" (set), "r" (oldset), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigpending" that takes set as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigpending")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: pending signal set
        "mov rax, %2\n"           Note: sigpending syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (set), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Suspension =====

Process called "sys_sigsuspend" that takes sigmask as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigsuspend")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal mask
        "mov rax, %2\n"           Note: sigsuspend syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (sigmask), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigwait" that takes set as Pointer, sig as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigwait")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal set
        "mov rsi, %2\n"           Note: received signal
        "mov rax, %3\n"           Note: sigwait syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (set), "r" (sig), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigwaitinfo" that takes set as Pointer, info as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigwaitinfo")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal set
        "mov rsi, %2\n"           Note: signal info
        "mov rax, %3\n"           Note: sigwaitinfo syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (set), "r" (info), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_sigtimedwait" that takes set as Pointer, info as Pointer, timeout as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigtimedwait")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal set
        "mov rsi, %2\n"           Note: signal info
        "mov rdx, %3\n"           Note: timeout
        "mov rax, %4\n"           Note: sigtimedwait syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (set), "r" (info), "r" (timeout), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Process Signaling =====

Process called "sys_kill" that takes pid as Integer, sig as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("kill")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: process ID
        "mov rsi, %2\n"           Note: signal number
        "mov rax, %3\n"           Note: kill syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (pid), "r" (sig), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_killpg" that takes pgrp as Integer, sig as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("killpg")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: process group
        "mov rsi, %2\n"           Note: signal number
        "mov rax, %3\n"           Note: killpg syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (pgrp), "r" (sig), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Thread Signaling =====

Process called "sys_thrkill" that takes tid as Integer, sig as Integer, tcb as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("thrkill")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: thread ID
        "mov rsi, %2\n"           Note: signal number
        "mov rdx, %3\n"           Note: thread control block
        "mov rax, %4\n"           Note: thrkill syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (tid), "r" (sig), "r" (tcb), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Stacks =====

Process called "sys_sigaltstack" that takes ss as Pointer, oss as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigaltstack")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: new signal stack
        "mov rsi, %2\n"           Note: old signal stack
        "mov rax, %3\n"           Note: sigaltstack syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (ss), "r" (oss), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Real-time Signals =====

Process called "sys_sigqueue" that takes pid as Integer, signo as Integer, value as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigqueue")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: process ID
        "mov rsi, %2\n"           Note: signal number
        "mov rdx, %3\n"           Note: signal value
        "mov rax, %4\n"           Note: sigqueue syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (pid), "r" (signo), "r" (value), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Return =====

Process called "sys_sigreturn" that takes sigcntxp as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("sigreturn")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: signal context pointer
        "mov rax, %2\n"           Note: sigreturn syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (sigcntxp), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Note: ===== Signal Timers =====

Process called "sys_timer_create" that takes clockid as Integer, evp as Pointer, timerid as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("timer_create")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: clock ID
        "mov rsi, %2\n"           Note: event pointer
        "mov rdx, %3\n"           Note: timer ID pointer
        "mov rax, %4\n"           Note: timer_create syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (clockid), "r" (evp), "r" (timerid), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_timer_delete" that takes timerid as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("timer_delete")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: timer ID
        "mov rax, %2\n"           Note: timer_delete syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (timerid), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_timer_settime" that takes timerid as Integer, flags as Integer, new_value as Pointer, old_value as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("timer_settime")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: timer ID
        "mov rsi, %2\n"           Note: flags
        "mov rdx, %3\n"           Note: new timer value
        "mov r10, %4\n"           Note: old timer value
        "mov rax, %5\n"           Note: timer_settime syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (timerid), "r" (flags), "r" (new_value), "r" (old_value), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rdx", "r10", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_timer_gettime" that takes timerid as Integer, curr_value as Pointer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("timer_gettime")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: timer ID
        "mov rsi, %2\n"           Note: current timer value
        "mov rax, %3\n"           Note: timer_gettime syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (timerid), "r" (curr_value), "r" (syscall_num)
        : "rax", "rdi", "rsi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process

Process called "sys_timer_getoverrun" that takes timerid as Integer returns Integer:
    Let platform be PlatformInterface.get_current_platform()
    Let syscall_num be platform.get_syscall_number("timer_getoverrun")
    Let result be Integer
    
    Inline Assembly:
        "mov rdi, %1\n"           Note: timer ID
        "mov rax, %2\n"           Note: timer_getoverrun syscall number from registry
        "syscall\n"
        "mov %0, rax\n"
        : "=r" (result)
        : "r" (timerid), "r" (syscall_num)
        : "rax", "rdi", "rcx", "r11", "memory"
    End Assembly
    
    Return result
End Process
